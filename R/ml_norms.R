# ml_norms: Compute item norms

#' Generate item-level norms for age, sex, language profile and item dominance
#' @export ml_norms
#' @importFrom googlesheets4 gs4_has_token
#' @importFrom dplyr mutate
#' @importFrom dplyr filter
#' @importFrom dplyr select
#' @importFrom dplyr left_join
#' @importFrom dplyr group_by_at
#' @importFrom dplyr between
#' @importFrom dplyr summarise
#' @importFrom dplyr rowwise
#' @importFrom dplyr arrange
#' @importFrom tidyr pivot_longer
#' @importFrom tidyr drop_na
#' @importFrom rlang .data
#' @param responses Responses data frame, as generated by \code{ml_responses}. If NULL (default), \code{ml_responses} is run.
#' @param participants Participants data frame, as generated by \code{ml_participants}. If NULL (default), \code{ml_participants} is run.
#' @param norms_item Character string indicating the item to compute norms for. If left NULL (by default) norms will be computed for all items.
#' @param norms_language Language to compute vocabulary norms for: "catalan" and/or "spanish"
#' @param norms_type Vocabulary type to compute norms for: "understands", "produces"
#' @param norms_age Age range of participants to compute norms for. It takes a numeric vector of length two (min-max).
#' @param norms_lp Language profile of participants to compute norms for: "Bilingual", Monolingual", "Other"
#' @param norms_sex Sex of participants to compute norms for: "Female", "Male". Both included by default.
#' @param norms_category Semantic/functional category to include items from
#' @param conf Confidence level of confidence intervals. Defaults to 0.95.
#' @return A dataset with each participant's comprehensive and/or vocabulary size in each language
#'

ml_norms <- function(
  participants = NULL,
  responses = NULL,
  norms_item = NULL,
  norms_language = c("Catalan", "Spanish"),
  norms_type = c("understands", "produces"),
  norms_age = c(0, 100),
  norms_lp = c("Bilingual", "Monolingual", "Other"),
  norms_sex = c("Female", "Male"),
  norms_category = NULL,
  conf = 0.95
) {
  if (!gs4_has_token()){
    ml_connect()
  }

  if (is.null(responses)) {
    if (is.null(participants)){
      participants <- ml_participants()
    }
    responses <- ml_responses(participants = participants)
  }
  logs <- ml_logs(participants = participants, responses = responses)


  group_vars <- c("te", "item", "language", "age_bin", "type", "lp", "category", "item_dominance", "ipa", "label")

  if (is.null(norms_item)) norms_item <- unique(responses$item)
  if (is.null(norms_category)) {
    norms_category <- unique(pool$category)
  }

  norms <- responses %>%
    left_join(select(.data$logs, .data$id, .data$time, .data$lp), c("id", "time")) %>%
    mutate(
      understands = ifelse(is.na(.data$response), NA, .data$response %in% c(2, 3)),
      produces = ifelse(is.na(.data$response), NA, .data$response %in% c(3))
    ) %>%
    select(
      .data$id, .data$age, .data$sex, .data$lp, .data$dominance,
      .data$item, .data$understands, .data$produces
    ) %>%
    pivot_longer(
      c(.data$understands, .data$produces),
      names_to = "type",
      values_to = "response") %>%
    mutate(age_bin = 2*as.numeric(
      cut(.data$age, seq(0, 100, by = 2), labels = FALSE))) %>%
    left_join(
      select(
        .data$pool, .data$te, .data$item, .data$language, .data$cognate,
        .data$label, .data$ipa, .data$frequency_zipf, .data$category
      ),
      by = "item"
    ) %>%
    filter(
      .data$item %in% .data$norms_item,
      .data$language %in% .data$norms_language,
      .data$type %in% .data$norms_type,
      .data$category %in% .data$norms_category,
      between(.data$age, .data$norms_age[1], .data$norms_age[2])
    ) %>%
    mutate(
      item_dominance = case_when(
        .data$language==.data$dominance ~ "L1",
        .data$language!=.data$dominance ~ "L2"
      )) %>%
    drop_na(.data$response) %>%
    group_by_at(group_vars) %>%
    summarise(
      yes = sum(.data$response, na.rm = TRUE),
      n = sum(!is.na(.data$response), na.rm = TRUE),
      .groups = "drop"
    ) %>%
    rowwise() %>%
    mutate(
      proportion = prop_adj(.data$yes, .data$n),
      se = prop_adj_se(.data$yes, .data$n),
      ci_lower = prop_adj_ci(.data$yes, .data$n, .width = conf)[1],
      ci_upper = prop_adj_ci(.data$yes, .data$n, .width = conf)[2]
    ) %>%
    ungroup() %>%
    filter(.data$type %in% .data$norms_type) %>%
    arrange(
      .data$te, .data$item, .data$language, .data$lp, .data$item_dominance,
      .data$type, .data$age_bin, .data$proportion, .data$yes, .data$n, .data$se, .data$ci_lower, .data$ci_upper
    )

  return(norms)

}
